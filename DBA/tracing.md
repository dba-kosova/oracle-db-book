# Tracing

Credit: Soure of a lot of this information is Effective Oracle by Design, Thomas Kyte

## SQL\*Plus

Not "tracing" per se, but it's a good idea to set up SQL*Plus with some basic parameters to show performance info.

First, the user must have the role `PLUSTRACE` which grants them access to some relevant tables in order to show the stats.

The SQL\*Plus help shows us:

```
AUTOT[RACE] {OFF|ON|TRACE[ONLY]}
    [EXP[LAIN]] [STAT[ISTICS]]
```

So with this turned on, after executing the query, sqlplus can show us the stats and the explain plan. If you ommit explain or stats, it will be default return both of those datasets.

If you do traceonly, the actual output of your query will not be returned and only the relevant stats requested.

The alternative method of getting the explain plan is to prefix your query with the text `explain plan for`, and then after you execute the query, query the function `table(dbms_xplain.display)`.

```
explain plan for select * from emp;

select *
from table(dbms_xplan.display);
```

You probably also want to enable timing to see how long it took to run the query. This is done with:

```
set timing on
```

## TKPROF

This is a low-level tracing which will include tracing for SQL and PL/SQL including timing, wait events, logical and physical I/O, CPU and wall clock timings, rows processed, query plans. The trace file itself is not easily readible, but TKPROF will make a readable file for us from the trace file generated by the database.

To enable tracing you will want to enable timed statistics

```
alter session set timed_statistics=true
```

Without this turned on, there isn't much helpful information as it won't contain cpu or elapsed times.

The different levels of tracing available, signified by an integer are:

1: Standard facility, as if doing `alter session set SQL_TRACE=true`
4: 1 + captures bind variable values
8: 1 + captures wait events
12: Everything - 1,4 and 8.

So, we would want to use `12` for our trace, and our session statement would end up looking like:

```
alter session set events '10046 trace name context forever, level 12'
```

nb: The TKPROF report won't show bind variables - for that you do need to look into the actual trace file.

After enabled, you would run some processes (or run your application). Then you need to figure out the filename. Once you know the general path where traces are saved, you probably wouldn't need to run this query and just navigate directly on the server.

```sql
select
    rtrim(dump_dest.value, '/')
    || '/'
    || inst.instance_name
    || '_ora_'
    || ltrim(to_char(proc.spid))
    || '.trc'
from
    v$process proc
    join v$session sess on (proc.addr = sess.paddr and sess.audsid = sys_context('userenv', 'sessionid'))
    join v$parameter dump_dest on (dump_dest.name = 'user_dump_dest')
    cross join v$instance inst
```

Once we find the trace filename and confirm, we want to convert it into TKPROF format. TKPROF is an OS command, so on your shell, run:

```
tkprof /path/to/file.trc tk.prf
```

`tk.prf` is a text file which we can now inspect.

nb: The book contains more info about analysing the data in the report you may want to check out if analysing a tkprof/trace (~pg128).

One way to get access to developers to the traces is to set `_TRACE_FILES_PUBLIC=TRUE` (undocumented) in `init.ora` - assuming devs have shell access to the machine, this makes the files readable by everyone (usually restricted to dba OS users).

Otherwise, some other workaround to move the traces to a place where devs can access them. One such workaround is a limited schema that leverages a logoff trigger to capture the trace files if one exists

## Other tools

Other tools you many want to consider

* runstats - there is an example in the book, also [oracle-developer released a variant](https://github.com/oracle-developer/runstats) on GitHub, but without any license. It logs statistics with the key piece of information being the latching.
* statspack - describes howt he database has been performing. It is designed to be run as sysdba, and can be installed by the script: `$ORACLE_HOME/rdbms/admin/spcreate.sql`
* DBMS_PROFILER - this can poinpont code that should be given some attention and help to ensure you have good code coverage in your test cases and identify code that if tuned would give you a good performance boost.